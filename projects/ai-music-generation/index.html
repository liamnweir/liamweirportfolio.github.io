<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Music Generation System | Liam Weir</title>

  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

  <style>
    :root{
      --bg0:#07071a;
      --bg1:#0b1634;
      --panel: rgba(255,255,255,0.085);
      --panel2: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.14);
      --text:#eef0ff;
      --muted: rgba(238,240,255,0.78);

      --p:#7c5cff;   /* purple */
      --m:#2fe3b4;   /* mint */
      --b:#4cc9ff;   /* blue */
      --o:#ffb86b;   /* orange */
      --r:#ff5ca8;   /* pink */

      --shadow: 0 22px 70px rgba(0,0,0,0.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }

    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 12% 8%, rgba(124,92,255,0.35), transparent 60%),
        radial-gradient(900px 600px at 88% 18%, rgba(47,227,180,0.22), transparent 62%),
        radial-gradient(900px 600px at 60% 92%, rgba(76,201,255,0.18), transparent 65%),
        radial-gradient(800px 560px at 30% 78%, rgba(255,92,168,0.13), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none }

    /* Top bar */
    .topbar{
      position:fixed; top:0; left:0; width:100%;
      z-index:20;
      padding: 14px 16px;
      display:flex;
      justify-content:flex-start;
      background: rgba(10,12,30,0.68);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:
        linear-gradient(135deg, rgba(124,92,255,0.24), rgba(47,227,180,0.14));
      box-shadow: 0 14px 32px rgba(0,0,0,0.25);
    }
    .back:hover{ filter:brightness(1.08) }

    .wrap{ max-width:1160px; margin:0 auto; padding: 92px 16px 64px }

    .hero{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:14px;
    }
    h1{ margin:0 0 8px; font-size:2.35rem; letter-spacing:.2px }
    p{ margin:8px 0; line-height:1.7; color:var(--muted) }

    .pills{ display:flex; flex-wrap:wrap; gap:8px }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size:.86rem;
      color: rgba(238,240,255,0.86);
    }
    .dot{ width:9px; height:9px; border-radius:999px; box-shadow:0 0 0 4px rgba(255,255,255,0.10) }
    .dot.p{ background:rgba(124,92,255,0.95); box-shadow:0 0 0 4px rgba(124,92,255,0.20) }
    .dot.m{ background:rgba(47,227,180,0.95); box-shadow:0 0 0 4px rgba(47,227,180,0.18) }
    .dot.b{ background:rgba(76,201,255,0.95); box-shadow:0 0 0 4px rgba(76,201,255,0.18) }
    .dot.o{ background:rgba(255,184,107,0.95); box-shadow:0 0 0 4px rgba(255,184,107,0.18) }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      margin-top: 14px;
    }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background:
        linear-gradient(135deg, rgba(124,92,255,0.16), rgba(47,227,180,0.10), rgba(76,201,255,0.10));
    }
    .card .bd{ padding: 16px }

    h2{ margin:0; font-size:1.2rem }
    h3{ margin:0 0 8px; font-size:1.05rem }
    .tiny{ font-size:.88rem; color: rgba(238,240,255,0.72) }
    .mono{ font-family: var(--mono) }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end }
    .field{ min-width: 170px; flex: 1 1 170px }
    .label{ font-size:.9rem; color: rgba(238,240,255,0.82); margin: 0 0 6px }

    select,input[type="text"],input[type="range"]{
      width:100%;
      background: rgba(255,255,255,0.09);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
    }
    select:focus,input:focus{
      border-color: rgba(124,92,255,0.58);
      box-shadow: 0 0 0 4px rgba(124,92,255,0.18);
    }
    input[type="range"]{ padding: 10px 0 }

    .btn{
      appearance:none;
      cursor:pointer;
      user-select:none;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-weight: 900;
      letter-spacing:.2px;
      transition: transform .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.08) }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none }

    .btn.primary{
      border-color: rgba(124,92,255,0.38);
      background: linear-gradient(135deg, rgba(124,92,255,0.30), rgba(76,201,255,0.16));
    }
    .btn.play{
      border-color: rgba(47,227,180,0.34);
      background: linear-gradient(135deg, rgba(47,227,180,0.22), rgba(124,92,255,0.12));
    }
    .btn.warn{
      border-color: rgba(255,184,107,0.32);
      background: linear-gradient(135deg, rgba(255,184,107,0.18), rgba(255,92,168,0.10));
    }

    .hr{ border:0; border-top: 1px solid rgba(255,255,255,0.10); margin: 14px 0 }

    .alert{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,184,107,0.36);
      background: rgba(255,184,107,0.12);
      color: rgba(255,245,235,0.95);
    }

    /* Melody chips (replaces raw text) */
    .chipsWrap{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      padding: 12px;
    }
    .chipsHead{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      position:relative;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      min-width: 64px;
      overflow:hidden;
    }
    .chip .n{ font-weight: 900; letter-spacing:.2px; font-size:.92rem }
    .chip .bar{
      position:absolute;
      left:8px;
      right:8px;
      bottom:7px;
      height:4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .chip .bar > i{
      display:block;
      height:100%;
      width:50%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(124,92,255,0.95), rgba(47,227,180,0.95), rgba(76,201,255,0.95));
      opacity:0.95;
    }

    /* Piano roll canvas wrap */
    .canvasWrap{
      margin-top: 12px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(900px 280px at 15% 30%, rgba(124,92,255,0.16), transparent 60%),
        radial-gradient(900px 280px at 85% 70%, rgba(47,227,180,0.12), transparent 60%),
        rgba(0,0,0,0.22);
    }
    canvas{ display:block; width:100%; height:auto }

    /* Right panel metrics */
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .kv:last-child{ border-bottom:none }

    /* Ratings */
    .stars{ display:flex; gap:6px; align-items:center }
    .star{
      width:36px; height:36px;
      border-radius: 12px;
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      cursor:pointer;
      user-select:none;
      font-size:18px;
      transition: transform .15s ease, filter .15s ease;
    }
    .star:hover{ transform: translateY(-1px); filter:brightness(1.08) }
    .star.on{
      border-color: rgba(255,184,107,0.42);
      background: linear-gradient(135deg, rgba(255,184,107,0.28), rgba(124,92,255,0.14));
    }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:.92rem }
    th,td{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.10); vertical-align:top }
    th{ text-align:left; color: rgba(238,240,255,0.86); font-weight: 900 }
  </style>
</head>

<body>
  <div class="topbar">
    <a class="back" href="https://liamnweir.github.io/liamweirportfolio.github.io/">← Back to Home</a>
  </div>

  <div class="wrap">
    <div class="hero">
      <div>
        <h1>AI Music Generation System</h1>
        <p>
          Generate short symbolic melodies with controls for key/mode, tempo, length, and melodic motion.
          Play results instantly, export MIDI, and collect listening ratings for comparison.
        </p>
      </div>

      <div class="pills">
        <span class="pill"><span class="dot p"></span>Generator</span>
        <span class="pill"><span class="dot m"></span>Playback</span>
        <span class="pill"><span class="dot b"></span>MIDI Export</span>
        <span class="pill"><span class="dot o"></span>Listening Ratings</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hd">
          <h2>Controls</h2>
          <div class="tiny" style="margin-top:6px">Generate → Play → Rate (saved locally on this device)</div>
        </div>

        <div class="bd">
          <div class="row">
            <div class="field">
              <div class="label">Key</div>
              <select id="key">
                <option value="C">C</option><option value="C#">C#</option><option value="D">D</option><option value="D#">D#</option>
                <option value="E">E</option><option value="F">F</option><option value="F#">F#</option><option value="G">G</option>
                <option value="G#">G#</option><option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
              </select>
            </div>

            <div class="field">
              <div class="label">Mode</div>
              <select id="mode">
                <option value="major">Major (Ionian)</option>
                <option value="natural_minor">Natural Minor (Aeolian)</option>
                <option value="harmonic_minor">Harmonic Minor</option>
                <option value="dorian">Dorian</option>
                <option value="mixolydian">Mixolydian</option>
              </select>
            </div>

            <div class="field" style="min-width:220px">
              <div class="label">Tempo: <span id="tempoVal">110</span> BPM</div>
              <input id="tempo" type="range" min="70" max="170" value="110" />
            </div>

            <div class="field" style="min-width:220px">
              <div class="label">Stepwise Bias: <span id="biasVal">0.75</span></div>
              <input id="bias" type="range" min="0" max="1" step="0.01" value="0.75" />
            </div>

            <div class="field">
              <div class="label">Length</div>
              <select id="length">
                <option value="8">8 notes</option>
                <option value="16" selected>16 notes</option>
                <option value="24">24 notes</option>
                <option value="32">32 notes</option>
              </select>
            </div>

            <div class="field">
              <div class="label">Instrument</div>
              <select id="inst">
                <option value="piano" selected>Piano-ish</option>
                <option value="strings">Strings pad</option>
                <option value="soft">Soft synth</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="genBtn">Generate</button>
            <button class="btn play" id="playBtn" disabled>Play</button>
            <button class="btn warn" id="stopBtn" disabled>Stop</button>
            <button class="btn" id="midiBtn" disabled>Export MIDI</button>
          </div>

          <div id="warn" class="alert"></div>

          <!-- REPLACES RAW TEXT OUTPUT -->
          <div class="chipsWrap" aria-label="Generated melody preview">
            <div class="chipsHead">
              <div>
                <div class="label" style="margin:0">Melody preview</div>
                <div class="tiny" id="melodyMeta">—</div>
              </div>
              <div class="tiny">Bars = relative duration</div>
            </div>
            <div class="chips" id="chips">
              <div class="tiny">Click Generate to create a melody.</div>
            </div>
          </div>

          <div class="canvasWrap" aria-label="Piano roll">
            <canvas id="roll"></canvas>
          </div>
          <div class="tiny" id="rollInfo" style="margin-top:8px">—</div>

          <div class="hr"></div>

          <h3>Listening Ratings</h3>
          <p class="tiny">Rate the current melody. Ratings are stored locally and exportable as CSV.</p>

          <div class="row" style="align-items:center">
            <div>
              <div class="label">Stars</div>
              <div class="stars" id="stars">
                <div class="star" data-s="1">★</div><div class="star" data-s="2">★</div><div class="star" data-s="3">★</div>
                <div class="star" data-s="4">★</div><div class="star" data-s="5">★</div>
              </div>
            </div>

            <div style="flex:1;min-width:260px">
              <div class="label">Optional comment</div>
              <input id="comment" type="text" placeholder="e.g., 'Good contour, cadence feels strong'" />
            </div>

            <div class="row" style="align-items:flex-end">
              <button class="btn primary" id="saveBtn" disabled>Save</button>
              <button class="btn" id="csvBtn">Export CSV</button>
              <button class="btn" id="clearBtn">Clear</button>
            </div>
          </div>

          <table>
            <thead>
              <tr><th style="width:120px">Stars</th><th>Condition</th><th style="width:140px">Notes</th></tr>
            </thead>
            <tbody id="ratingsBody">
              <tr><td colspan="3" class="tiny">No ratings yet.</td></tr>
            </tbody>
          </table>

          <p class="tiny">
            Shortcuts: <span class="mono">Space</span> play/stop • <span class="mono">G</span> generate • <span class="mono">M</span> export MIDI
          </p>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <div class="hd">
          <h2>Metrics + Results</h2>
          <div class="tiny" style="margin-top:6px">Metrics update per melody; plots update from saved ratings.</div>
        </div>

        <div class="bd">
          <h3>Structure Metrics (current)</h3>
          <div class="kv"><span>Repetition</span><strong id="m_rep">—</strong></div>
          <div class="kv"><span>Stepwise motion</span><strong id="m_step">—</strong></div>
          <div class="kv"><span>Range (semitones)</span><strong id="m_range">—</strong></div>
          <div class="kv"><span>Tonal stability</span><strong id="m_tonal">—</strong></div>

          <div class="hr"></div>

          <h3>Ratings Summary (this device)</h3>
          <div class="canvasWrap" style="margin-top:10px">
            <canvas id="plot1"></canvas>
          </div>
          <div class="tiny" style="margin-top:6px">Rating distribution (counts)</div>

          <div class="canvasWrap" style="margin-top:12px">
            <canvas id="plot2"></canvas>
          </div>
          <div class="tiny" style="margin-top:6px">Average rating by mode</div>

          <div class="canvasWrap" style="margin-top:12px">
            <canvas id="plot3"></canvas>
          </div>
          <div class="tiny" style="margin-top:6px">Average rating by bias bucket</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // -------------------------
    // Helpers
    // -------------------------
    const $ = (id) => document.getElementById(id);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const nowISO = () => new Date().toISOString();

    // -------------------------
    // Music theory
    // -------------------------
    const NOTE = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};
    const MODES = {
      major:         [0,2,4,5,7,9,11],
      natural_minor: [0,2,3,5,7,8,10],
      harmonic_minor:[0,2,3,5,7,8,11],
      dorian:        [0,2,3,5,7,9,10],
      mixolydian:    [0,2,4,5,7,9,10],
    };
    const NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    function midiToName(m){
      const name = NAMES[m % 12];
      const oct = Math.floor(m/12) - 1;
      return name + oct;
    }

    // -------------------------
    // Elements
    // -------------------------
    const keyEl = $("key"), modeEl = $("mode"), tempoEl = $("tempo"), tempoVal = $("tempoVal");
    const biasEl = $("bias"), biasVal = $("biasVal"), lenEl = $("length"), instEl = $("inst");
    const genBtn = $("genBtn"), playBtn = $("playBtn"), stopBtn = $("stopBtn"), midiBtn = $("midiBtn");
    const warnEl = $("warn");
    const roll = $("roll"), rollInfo = $("rollInfo");

    const chipsEl = $("chips");
    const melodyMeta = $("melodyMeta");

    const mRep = $("m_rep"), mStep = $("m_step"), mRange = $("m_range"), mTonal = $("m_tonal");

    const starsWrap = $("stars"), commentEl = $("comment"), saveBtn = $("saveBtn"), csvBtn = $("csvBtn"), clearBtn = $("clearBtn"), ratingsBody = $("ratingsBody");
    const plot1 = $("plot1"), plot2 = $("plot2"), plot3 = $("plot3");

    tempoEl.addEventListener("input", () => tempoVal.textContent = tempoEl.value);
    biasEl.addEventListener("input", () => biasVal.textContent = Number(biasEl.value).toFixed(2));

    // -------------------------
    // State
    // -------------------------
    let phrase = null; // [{midi, durBeats}]
    let currentStars = 0;

    // -------------------------
    // Alerts
    // -------------------------
    function setWarn(msg){
      if(!msg){ warnEl.style.display="none"; warnEl.textContent=""; return; }
      warnEl.style.display="block";
      warnEl.textContent = msg;
    }

    // -------------------------
    // Audio
    // -------------------------
    let synth = null, part = null;
    let masterReady = false;
    let masterGain, reverb, limiter;

    function ensureMaster(){
      if(masterReady) return;
      masterGain = new Tone.Gain(0.92);
      reverb = new Tone.Reverb({decay:2.1, preDelay:0.01, wet:0.18});
      limiter = new Tone.Limiter(-1);
      masterGain.connect(limiter);
      limiter.toDestination();
      masterReady = true;
    }

    function buildSynth(kind){
      ensureMaster();
      if(synth){ try{synth.dispose();}catch(e){} synth=null; }

      const base = {
        volume: -8,
        oscillator: { type: "triangle" },
        envelope: { attack: 0.01, decay: 0.25, sustain: 0.25, release: 0.9 }
      };

      if(kind === "strings"){
        base.oscillator.type = "sawtooth";
        base.envelope = { attack: 0.12, decay: 0.18, sustain: 0.75, release: 1.3 };
        base.volume = -10;
      } else if (kind === "soft"){
        base.oscillator.type = "sine";
        base.envelope = { attack: 0.01, decay: 0.08, sustain: 0.20, release: 0.35 };
        base.volume = -10;
      }

      synth = new Tone.PolySynth(Tone.Synth, base);
      synth.connect(masterGain);
      synth.connect(reverb);
      reverb.connect(masterGain);
      return synth;
    }

    async function ensureAudio(){
      if(Tone.context.state !== "running") await Tone.start();
      buildSynth(instEl.value);
    }

    function stopPlayback(){
      if(part){ try{part.stop(); part.dispose();}catch(e){} part=null; }
      Tone.Transport.stop();
      Tone.Transport.cancel();
      Tone.Transport.position = 0;
      playBtn.disabled = !phrase;
      stopBtn.disabled = true;
    }

    function schedulePlayback(notes){
      Tone.Transport.stop();
      Tone.Transport.cancel();
      Tone.Transport.position = 0;
      Tone.Transport.bpm.value = Number(tempoEl.value);

      let t = 0;
      const events = notes.map(n => {
        const evt = { time: t, midi: clamp(n.midi, 24, 108), dur: Number(n.durBeats) };
        t += evt.dur;
        return evt;
      });

      part = new Tone.Part((time, v) => {
        const name = midiToName(v.midi);
        const durSec = Tone.Time(v.dur).toSeconds();
        synth.triggerAttackRelease(name, durSec, time, 0.9);
      }, events);

      part.start(0);
      Tone.Transport.start("+0.02");
    }

    // -------------------------
    // Generator
    // -------------------------
    function allowedNotes(root, modeKey){
      const pcs = MODES[modeKey].map(x => (x + root));
      const base = 60;
      const out = [];
      for(let oct=-1; oct<=1; oct++){
        for(const pc of pcs) out.push(base + pc + 12*oct);
      }
      return out.sort((a,b)=>a-b);
    }

    function sampleDur(){
      const r = Math.random();
      if(r < 0.12) return 0.125;
      if(r < 0.65) return 0.25;
      if(r < 0.92) return 0.5;
      return 1.0;
    }

    function generate({key, mode, bias, length}){
      const root = NOTE[key];
      const allowed = allowedNotes(root, mode);
      const tonic = 60 + root;

      let cur = tonic;
      const notes = [];

      for(let i=0;i<length;i++){
        const near = allowed.filter(n => Math.abs(n - cur) <= 2);
        const pool = (Math.random() < bias && near.length) ? near : allowed;

        const target = (i < length/2) ? cur + 2 : cur - 2;
        const weighted = pool
          .map(n => ({n, w: 1 / (1 + Math.abs(n - target))}))
          .sort((a,b)=>b.w-a.w)
          .slice(0, Math.max(6, Math.floor(pool.length*0.35)))
          .map(x=>x.n);

        let finalPool = weighted;
        if(i >= length-2){
          const dom = tonic + 7;
          const cad = allowed.filter(n => Math.min(Math.abs(n-tonic), Math.abs(n-dom)) <= 3);
          if(cad.length) finalPool = cad;
        }

        cur = pick(finalPool);
        const d = (i===length-1) ? 0.5 : sampleDur();
        notes.push({midi: cur, durBeats: d});
      }

      return notes;
    }

    // -------------------------
    // Metrics
    // -------------------------
    function metrics(notes, key, mode){
      const midis = notes.map(n=>n.midi);

      const uniq = new Set(midis);
      const repetition = 1 - (uniq.size / midis.length);

      let steps=0;
      for(let i=1;i<midis.length;i++){
        if(Math.abs(midis[i]-midis[i-1])<=2) steps++;
      }
      const stepwise = steps / Math.max(1, midis.length-1);

      const range = Math.max(...midis) - Math.min(...midis);

      const root = NOTE[key];
      const minorish = (mode.includes("minor") || mode==="dorian");
      const triad = minorish ? [0,3,7] : [0,4,7];
      const triadPC = new Set(triad.map(x => (x + root) % 12));
      const tonal = midis.filter(m => triadPC.has(m%12)).length / midis.length;

      return {repetition, stepwise, range, tonal};
    }

    function renderMetrics(m){
      mRep.textContent   = m.repetition.toFixed(2);
      mStep.textContent  = m.stepwise.toFixed(2);
      mRange.textContent = String(m.range);
      mTonal.textContent = m.tonal.toFixed(2);
    }

    // -------------------------
    // Melody preview chips (NO RAW TEXT)
    // -------------------------
    function sumBeats(notes){ return notes.reduce((a,n)=>a+n.durBeats, 0); }

    function renderChips(notes){
      if(!notes || !notes.length){
        chipsEl.innerHTML = `<div class="tiny">Click Generate to create a melody.</div>`;
        melodyMeta.textContent = "—";
        return;
      }
      const total = sumBeats(notes);
      const maxDur = Math.max(...notes.map(n=>n.durBeats));
      melodyMeta.textContent = `${notes.length} notes • ${total.toFixed(2)} beats`;

      chipsEl.innerHTML = notes.map(n => {
        const w = Math.max(12, Math.round((n.durBeats / maxDur) * 100));
        const name = midiToName(n.midi);
        return `
          <div class="chip" title="${name}">
            <div class="n">${name}</div>
            <div class="bar"><i style="width:${w}%"></i></div>
          </div>
        `;
      }).join("");
    }

    // -------------------------
    // Piano roll (colorful)
    // -------------------------
    function fitCanvas(canvas, cssH){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = Math.max(320, Math.floor(canvas.getBoundingClientRect().width));
      canvas.width = Math.floor(w*dpr);
      canvas.height = Math.floor(cssH*dpr);
      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx, w, h: cssH};
    }
    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
    function isBlackKey(pc){ return [1,3,6,8,10].includes(pc); }

    function pitchFill(midi){
      const t = (midi - 36) / (96 - 36);
      const hue = 265 - (t * 220); // purple -> green/cyan
      return `hsla(${hue}, 92%, 60%, 0.62)`;
    }
    function pitchStroke(midi){
      const t = (midi - 36) / (96 - 36);
      const hue = 265 - (t * 220);
      return `hsla(${hue}, 95%, 70%, 0.95)`;
    }

    function drawRoll(notes){
      const cssH = 270;
      const {ctx, w, h} = fitCanvas(roll, cssH);

      const bg = ctx.createLinearGradient(0,0,w,h);
      bg.addColorStop(0, "rgba(8,10,26,0.86)");
      bg.addColorStop(1, "rgba(7,8,18,0.62)");
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      if(!notes || !notes.length){
        rollInfo.textContent = "—";
        return;
      }

      const midis = notes.map(n=>n.midi);
      const lo = Math.min(...midis), hi = Math.max(...midis);
      const pad = 3;
      const minM = Math.max(24, lo-pad), maxM = Math.min(108, hi+pad);
      const rows = Math.max(1, maxM - minM + 1);

      const left = 14, right = 12, top = 12, bottom = 12;
      const usableW = w - left - right;
      const usableH = h - top - bottom;
      const rowH = usableH / rows;

      const total = sumBeats(notes);
      const beatW = usableW / Math.max(0.001, total);

      // lanes
      for(let r=0;r<rows;r++){
        const midi = maxM - r;
        const pc = midi % 12;
        const y = top + r*rowH;
        const black = isBlackKey(pc);
        ctx.fillStyle = black ? "rgba(255,255,255,0.040)" : "rgba(255,255,255,0.022)";
        ctx.fillRect(left, y, usableW, rowH);
      }

      // beat grid
      const quarters = Math.ceil(total / 0.25);
      for(let b=0;b<=quarters;b++){
        const x = left + (b*0.25)*beatW;
        const isBar = (b % 16 === 0);
        ctx.strokeStyle = isBar ? "rgba(76,201,255,0.16)" : "rgba(255,255,255,0.08)";
        ctx.lineWidth = isBar ? 1.6 : 1;
        ctx.beginPath();
        ctx.moveTo(x, top);
        ctx.lineTo(x, h-bottom);
        ctx.stroke();
      }

      // notes
      let t=0;
      for(const n of notes){
        const x = left + t*beatW;
        const nw = Math.max(3, n.durBeats*beatW);
        const y = top + (maxM - n.midi)*rowH + 1;
        const nh = Math.max(3, rowH-2);

        // shadow
        ctx.fillStyle = "rgba(0,0,0,0.24)";
        roundRect(ctx, x+3, y+2, Math.max(2, nw-2), nh, 10);
        ctx.fill();

        // main
        ctx.fillStyle = pitchFill(n.midi);
        ctx.strokeStyle = pitchStroke(n.midi);
        ctx.lineWidth = 1.2;
        roundRect(ctx, x+1, y, Math.max(2, nw-2), nh, 10);
        ctx.fill();
        ctx.stroke();

        // highlight
        ctx.fillStyle = "rgba(255,255,255,0.10)";
        roundRect(ctx, x+2, y+1, Math.max(2, nw-4), Math.max(2, nh*0.35), 10);
        ctx.fill();

        t += n.durBeats;
      }

      rollInfo.textContent = `Range: ${hi-lo} semitones • Total: ${total.toFixed(2)} beats`;
    }

    window.addEventListener("resize", () => drawRoll(phrase));

    // -------------------------
    // MIDI export
    // -------------------------
    function exportMIDI(notes, bpm){
      const PPQ = 480;
      const u16 = n => [(n>>8)&255, n&255];
      const u32 = n => [(n>>24)&255, (n>>16)&255, (n>>8)&255, n&255];
      const str = s => Array.from(s).map(c=>c.charCodeAt(0));
      function vlq(n){
        let bytes = [n & 0x7F];
        while((n >>= 7)) bytes.unshift((n & 0x7F) | 0x80);
        return bytes;
      }

      const header = [...str("MThd"), ...u32(6), ...u16(0), ...u16(1), ...u16(PPQ)];
      const ev = [];

      const mpqn = Math.round(60000000 / Math.max(1, bpm));
      ev.push(...vlq(0), 0xFF, 0x51, 0x03, (mpqn>>16)&255, (mpqn>>8)&255, mpqn&255);
      ev.push(...vlq(0), 0xC0, 0x00);

      for(const n of notes){
        const durTicks = Math.max(1, Math.round(n.durBeats * PPQ));
        ev.push(...vlq(0),       0x90, clamp(n.midi,0,127), 100);
        ev.push(...vlq(durTicks),0x80, clamp(n.midi,0,127), 0);
      }
      ev.push(...vlq(0), 0xFF, 0x2F, 0x00);

      const track = [...str("MTrk"), ...u32(ev.length), ...ev];
      const bytes = new Uint8Array([...header, ...track]);
      const blob = new Blob([bytes], {type:"audio/midi"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "generated_phrase.mid";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    midiBtn.addEventListener("click", () => {
      if(!phrase) return;
      exportMIDI(phrase, Number(tempoEl.value));
    });

    // -------------------------
    // Ratings + plots
    // -------------------------
    const RATINGS_KEY = "liam_ai_music_ratings_v4";

    function loadRatings(){
      try{ return JSON.parse(localStorage.getItem(RATINGS_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function saveRatings(list){
      localStorage.setItem(RATINGS_KEY, JSON.stringify(list));
    }

    function setStars(n){
      currentStars = n;
      starsWrap.querySelectorAll(".star").forEach(el => {
        const s = Number(el.dataset.s);
        el.classList.toggle("on", s <= n);
      });
      saveBtn.disabled = !(phrase && currentStars>0);
    }

    starsWrap.addEventListener("click", (e) => {
      const el = e.target.closest(".star");
      if(!el) return;
      setStars(Number(el.dataset.s));
    });

    function renderTable(){
      const list = loadRatings();
      if(!list.length){
        ratingsBody.innerHTML = `<tr><td colspan="3" class="tiny">No ratings yet.</td></tr>`;
        return;
      }
      const view = list.slice(-10).reverse();
      ratingsBody.innerHTML = view.map(r => `
        <tr>
          <td>${"★".repeat(r.stars)}${"☆".repeat(5-r.stars)}</td>
          <td>${r.key} ${r.mode.replaceAll("_"," ")} • tempo ${r.bpm} • bias ${Number(r.bias).toFixed(2)}</td>
          <td>${r.length}</td>
        </tr>
      `).join("");
    }

    function downloadText(filename, text, type){
      const blob = new Blob([text], {type: type || "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    saveBtn.addEventListener("click", () => {
      if(!phrase || !currentStars) return;

      const key = keyEl.value;
      const mode = modeEl.value;
      const bpm = Number(tempoEl.value);
      const bias = Number(biasEl.value);
      const length = Number(lenEl.value);

      const m = metrics(phrase, key, mode);
      const entry = {
        ts: nowISO(),
        stars: currentStars,
        comment: (commentEl.value || "").trim(),
        key, mode, bpm, bias, length,
        metrics: m
      };

      const list = loadRatings();
      list.push(entry);
      saveRatings(list);

      commentEl.value = "";
      setStars(0);
      renderTable();
      renderPlots();
      setWarn(null);
    });

    csvBtn.addEventListener("click", () => {
      const list = loadRatings();
      if(!list.length){ setWarn("No ratings to export yet."); return; }

      const header = ["ts","stars","comment","key","mode","bpm","bias","length","repetition","stepwise","range","tonal"];
      const esc = (s) => `"${String(s ?? "").replaceAll('"','""')}"`;

      const rows = list.map(r => ([
        esc(r.ts),
        r.stars,
        esc(r.comment),
        esc(r.key),
        esc(r.mode),
        r.bpm,
        r.bias,
        r.length,
        (r.metrics?.repetition ?? "").toFixed?.(4) ?? "",
        (r.metrics?.stepwise ?? "").toFixed?.(4) ?? "",
        r.metrics?.range ?? "",
        (r.metrics?.tonal ?? "").toFixed?.(4) ?? ""
      ].join(",")));

      downloadText("ai_music_ratings.csv", [header.join(","), ...rows].join("\n"), "text/csv");
      setWarn(null);
    });

    clearBtn.addEventListener("click", () => {
      localStorage.removeItem(RATINGS_KEY);
      renderTable();
      renderPlots();
      setWarn(null);
    });

    function barChart(canvas, labels, values, title){
      const cssH = 200;
      const {ctx, w, h} = fitCanvas(canvas, cssH);
      ctx.clearRect(0,0,w,h);

      const bg = ctx.createLinearGradient(0,0,w,h);
      bg.addColorStop(0, "rgba(10,12,28,0.82)");
      bg.addColorStop(1, "rgba(7,8,18,0.62)");
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      const padL = 44, padR = 12, padT = 28, padB = 36;
      const innerW = w - padL - padR;
      const innerH = h - padT - padB;

      ctx.fillStyle = "rgba(238,240,255,0.88)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(title || "", 12, 18);

      const maxV = Math.max(1e-9, ...values);
      const n = values.length;
      const gap = 8;
      const barW = Math.max(6, (innerW - gap*(n-1)) / n);

      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + innerH);
      ctx.lineTo(padL + innerW, padT + innerH);
      ctx.stroke();

      ctx.fillStyle = "rgba(238,240,255,0.65)";
      ctx.font = "11px " + getComputedStyle(document.body).fontFamily;
      for(let t=0;t<=2;t++){
        const yVal = (maxV * t/2);
        const y = padT + innerH - (innerH * t/2);
        ctx.fillText(String(yVal.toFixed(1)).replace(".0",""), 8, y+4);
        ctx.strokeStyle = "rgba(255,255,255,0.06)";
        ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+innerW, y); ctx.stroke();
      }

      for(let i=0;i<n;i++){
        const v = values[i];
        const bh = (v/maxV)*innerH;
        const x = padL + i*(barW+gap);
        const y = padT + innerH - bh;

        const gg = ctx.createLinearGradient(0, y, 0, y+bh);
        gg.addColorStop(0, "rgba(124,92,255,0.68)");
        gg.addColorStop(1, "rgba(47,227,180,0.32)");

        ctx.fillStyle = gg;
        ctx.strokeStyle = "rgba(76,201,255,0.55)";
        ctx.lineWidth = 1.1;
        roundRect(ctx, x, y, barW, bh, 10);
        ctx.fill(); ctx.stroke();

        ctx.fillStyle = "rgba(238,240,255,0.72)";
        ctx.font = "11px " + getComputedStyle(document.body).fontFamily;
        const lab = labels[i];
        const tx = x + barW/2;
        ctx.save();
        ctx.translate(tx, padT + innerH + 14);
        ctx.rotate(-0.35);
        ctx.textAlign = "center";
        ctx.fillText(lab, 0, 0);
        ctx.restore();
      }
    }

    function renderPlots(){
      const list = loadRatings();

      const counts = [1,2,3,4,5].map(s => list.filter(r => r.stars===s).length);
      barChart(plot1, ["1","2","3","4","5"], counts, "Rating distribution (counts)");

      const byMode = {};
      for(const r of list){
        const k = r.mode;
        if(!byMode[k]) byMode[k] = {sum:0, n:0};
        byMode[k].sum += r.stars; byMode[k].n += 1;
      }
      const modeItems = Object.entries(byMode)
        .map(([k,v]) => ({k, avg: v.sum / Math.max(1,v.n), n:v.n}))
        .sort((a,b)=> (b.n - a.n) || (b.avg - a.avg))
        .slice(0, 6);

      barChart(
        plot2,
        modeItems.length ? modeItems.map(x => x.k.replaceAll("_"," ")) : ["—"],
        modeItems.length ? modeItems.map(x => Number(x.avg.toFixed(2))) : [0],
        "Average rating by mode"
      );

      const buckets = {};
      const bucketOf = (b) => (Math.round(b/0.25)*0.25).toFixed(2);
      for(const r of list){
        const k = bucketOf(Number(r.bias));
        if(!buckets[k]) buckets[k] = {sum:0,n:0};
        buckets[k].sum += r.stars; buckets[k].n += 1;
      }
      const bucketKeys = ["0.00","0.25","0.50","0.75","1.00"];
      const bucketVals = bucketKeys.map(k => buckets[k] ? (buckets[k].sum / buckets[k].n) : 0);

      barChart(plot3, bucketKeys, bucketVals, "Average rating by bias bucket");
    }

    // -------------------------
    // Main actions
    // -------------------------
    genBtn.addEventListener("click", () => {
      stopPlayback();
      setWarn(null);

      const key = keyEl.value;
      const mode = modeEl.value;
      const bias = Number(biasEl.value);
      const length = Number(lenEl.value);

      try{
        phrase = generate({key, mode, bias, length});

        renderChips(phrase);

        const m = metrics(phrase, key, mode);
        renderMetrics(m);

        drawRoll(phrase);

        playBtn.disabled = false;
        midiBtn.disabled = false;

        saveBtn.disabled = !(currentStars>0);
      }catch(e){
        phrase = null;
        renderChips(null);
        drawRoll(null);
        renderMetrics({repetition:0,stepwise:0,range:0,tonal:0});
        playBtn.disabled = true; stopBtn.disabled = true; midiBtn.disabled = true; saveBtn.disabled = true;
        setWarn(e?.message || "Generation failed.");
      }
    });

    playBtn.addEventListener("click", async () => {
      if(!phrase) return;
      setWarn(null);
      try{
        await ensureAudio();
        stopPlayback();
        schedulePlayback(phrase);
        playBtn.disabled = true;
        stopBtn.disabled = false;
      }catch(e){
        setWarn("Audio blocked by browser. Click Play again to enable sound.");
      }
    });

    stopBtn.addEventListener("click", stopPlayback);

    window.addEventListener("keydown", (e) => {
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      if(tag === "input" || tag === "textarea" || tag === "select") return;

      if(e.code === "Space"){
        e.preventDefault();
        if(!stopBtn.disabled) stopPlayback();
        else if(!playBtn.disabled) playBtn.click();
      }else if(e.key.toLowerCase() === "g"){
        genBtn.click();
      }else if(e.key.toLowerCase() === "m"){
        if(!midiBtn.disabled) midiBtn.click();
      }
    });

    // Init
    renderTable();
    renderPlots();
    renderChips(null);
    drawRoll(null);
    biasVal.textContent = Number(biasEl.value).toFixed(2);
    tempoVal.textContent = tempoEl.value;
  </script>
</body>
</html>









