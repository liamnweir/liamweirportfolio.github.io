<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Remix Assistant (MIDI) | Liam Weir</title>

  <!-- Tone.js playback -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <!-- MIDI parse + write (browser) -->
  <script src="https://unpkg.com/@tonejs/midi"></script>

  <style>
    :root{
      --bg0:#070712;
      --bg1:#0b0820;
      --bg2:#120a2c;
      --panel: rgba(255,255,255,.055);
      --panel2: rgba(255,255,255,.038);
      --border: rgba(255,255,255,.12);
      --text:#eef0ff;
      --muted:rgba(238,240,255,.78);
      --muted2:rgba(238,240,255,.62);
      --shadow: 0 30px 70px rgba(0,0,0,.52);
      --r: 18px;

      --redA: rgba(255, 90, 120, .22);
      --redB: rgba(255, 140, 80, .16);
      --redBorder: rgba(255, 90, 120, .55);

      --greenA: rgba(80, 255, 170, .18);
      --greenB: rgba(60, 220, 140, .12);
      --greenBorder: rgba(80, 255, 170, .48);

      --ok: rgba(120,255,190,.14);
      --okBorder: rgba(120,255,190,.28);
      --warnBg: rgba(255,170,120,.10);
      --warnBorder: rgba(255,170,120,.32);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 520px at 18% -10%, rgba(255, 90, 120, .20), transparent 58%),
        radial-gradient(860px 520px at 92% 0%, rgba(80, 255, 170, .14), transparent 62%),
        radial-gradient(980px 640px at 50% 110%, rgba(255, 140, 80, .10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 50%, var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}

    .topbar{
      position:sticky; top:0; z-index:10;
      background: rgba(10, 8, 26, .78);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(14px);
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{font-weight: 950; display:flex; align-items:center; gap:10px}
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, rgba(255, 90, 120,.95), rgba(80,255,170,.95));
      box-shadow: 0 0 0 5px rgba(255, 90, 120,.14);
    }
    .navBtn{
      text-decoration:none;
      font-weight: 900;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(238,240,255,.92);
      transition: filter .12s ease, transform .12s ease;
    }
    .navBtn:hover{filter:brightness(1.12); transform: translateY(-1px)}
    .navBtn.primary{
      background: linear-gradient(135deg, var(--redA), var(--redB));
      border: 1px solid var(--redBorder);
    }

    .wrap{max-width:1120px; margin:0 auto; padding: 18px 16px 70px}

    .hero{
      margin-top: 10px;
      padding: 16px;
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.035);
      box-shadow: var(--shadow);
    }
    h1{margin: 4px 0 8px; font-size: 2.1rem}
    p{margin: 6px 0; line-height: 1.6; color: var(--muted)}

    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap: 16px; margin-top: 16px}
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card.soft{ background: var(--panel2); }

    .card.remix{
      background:
        radial-gradient(900px 420px at 20% 0%, var(--redA), transparent 60%),
        radial-gradient(880px 420px at 90% 12%, rgba(255, 140, 80,.12), transparent 62%),
        rgba(255,255,255,.035);
      border-color: rgba(255, 90, 120,.38);
    }
    .card.stats{
      background:
        radial-gradient(900px 420px at 18% 0%, var(--greenA), transparent 60%),
        radial-gradient(880px 420px at 92% 12%, var(--greenB), transparent 62%),
        rgba(255,255,255,.035);
      border-color: rgba(80,255,170,.34);
    }

    .row{display:flex; flex-wrap:wrap; gap: 10px; align-items:flex-end}
    .field{min-width: 220px; flex:1}
    .field.sm{min-width: 170px; flex: .8}
    .field.xs{min-width: 140px; flex: .55}
    .label{font-size:.9rem; color: var(--muted); margin: 0 0 6px; font-weight: 850}

    select,input[type="text"],input[type="number"],input[type="file"],input[type="range"]{
      width:100%;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 14px;
      color: rgba(238,240,255,.92);
      padding: 10px 12px;
      outline:none;
      transition: filter .12s ease, border-color .12s ease;
    }
    select:focus,input:focus{
      border-color: rgba(255,255,255,.28);
      filter:brightness(1.06);
    }

    /* Range slider fill full track */
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      padding: 0;
      height: 36px;
      background: transparent;
      border: none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width: 22px;
      height: 22px;
      margin-top: -7px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255, 90, 120,.95), rgba(255, 140, 80,.85));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    input[type="range"]::-moz-range-track{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    input[type="range"]::-moz-range-thumb{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255, 90, 120,.95), rgba(255, 140, 80,.85));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .btn{
      appearance:none;
      border: 1px solid var(--redBorder);
      background: linear-gradient(135deg, var(--redA), var(--redB));
      color: rgba(238,240,255,.96);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      transition: filter .12s ease, transform .12s ease;
    }
    .btn:hover{filter:brightness(1.12); transform: translateY(-1px)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.16);
      font-weight: 900;
    }
    .btn.green{
      border-color: var(--greenBorder);
      background: linear-gradient(135deg, var(--greenA), var(--greenB));
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.16);
      font-weight: 900;
    }
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}

    .tiny{font-size:.88rem; color:var(--muted2); font-weight:800}
    .divider{border:0; border-top:1px solid rgba(255,255,255,.10); margin: 12px 0}

    .warn,.ok{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      white-space: pre-wrap;
      font-weight: 850;
    }
    .warn{border: 1px solid var(--warnBorder); background: var(--warnBg); color: #ffe9da;}
    .ok{border: 1px solid var(--okBorder); background: var(--ok); color: rgba(220,255,235,.96);}

    /* Better-looking log */
    .log{
      margin: 10px 0 0;
      padding: 12px 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(800px 260px at 10% 0%, rgba(255, 90, 120,.10), transparent 60%),
        radial-gradient(800px 260px at 90% 0%, rgba(80,255,170,.08), transparent 60%),
        rgba(0,0,0,.35);
      color: rgba(238,240,255,.92);
      overflow:auto;
      min-height: 160px;
      font-family: var(--mono);
      font-size: .92rem;
      line-height: 1.55;
    }
    .log .line{padding: 4px 2px; border-bottom: 1px dashed rgba(255,255,255,.08)}
    .log .line:last-child{border-bottom:none}
    .log .ts{color: rgba(238,240,255,.55)}
    .log .tag{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      margin-right: 8px;
      font-weight: 900;
      font-size: .82rem;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(238,240,255,.86);
    }
    .log .tag.ok{border-color: rgba(120,255,190,.28); background: rgba(120,255,190,.08)}
    .log .tag.warn{border-color: rgba(255,170,120,.32); background: rgba(255,170,120,.08)}
    .log .tag.info{border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.05)}
    .log .tag.play{border-color: rgba(80,255,170,.32); background: rgba(80,255,170,.08)}
    .log .tag.stop{border-color: rgba(255,90,120,.32); background: rgba(255,90,120,.08)}

    .kv{display:flex; justify-content:space-between; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.10)}
    .kv:last-child{border-bottom:none}
    .k{color: var(--muted)}
    .v{font-weight: 950}

    /* Samples + Bank list UI */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }
    .item .meta{min-width:0}
    .item .title{
      font-weight: 950;
      letter-spacing: -.2px;
      margin: 0 0 4px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .item .sub{
      color: var(--muted2);
      font-weight: 850;
      font-size: .88rem;
      line-height: 1.35;
    }
    .item .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:flex-end;
      align-items:center;
      flex: 0 0 auto;
    }
    .btn.xs{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: .88rem;
      font-weight: 950;
    }
    .inline{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(238,240,255,.82);
      font-size: .82rem;
      font-weight: 900;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <div class="brand"><span class="dot"></span>Remix Assistant</div>
      <a class="navBtn" href="https://liamnweir.github.io/liamweirportfolio.github.io/">← Back</a>
      <a class="navBtn primary" href="#bank">Bank</a>
    </div>
    <div class="tiny">Upload MIDI → remix → play → download → save</div>
  </div>

  <div class="wrap">
    <div class="hero">
      <h1>Remix Assistant (MIDI)</h1>
      <p>
        Upload a MIDI and generate a “better” version using simple music theory:
        diatonic reharm, smoother voice-leading, and a lightly improved melody while keeping the same vibe.
      </p>
    </div>

    <div class="grid">
      <!-- LEFT: Remix -->
      <section class="card remix">
        <div class="row">
          <div class="field">
            <div class="label">Upload MIDI (.mid)</div>
            <input id="midiFile" type="file" accept=".mid,.midi,audio/midi" />
            <div class="tiny" style="margin-top:6px">
              Multi-track works. The tool picks a melody track automatically.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field sm">
            <div class="label">Style</div>
            <select id="style">
              <option value="lofi" selected>Lofi</option>
              <option value="edm">EDM</option>
              <option value="baroque">Baroque-ish</option>
            </select>
          </div>

          <div class="field sm">
            <div class="label">Remix strength</div>
            <input id="strength" type="range" min="0" max="1" step="0.01" value="0.65" />
            <div class="tiny">Value: <span id="strengthVal">0.65</span></div>
          </div>

          <div class="field sm">
            <div class="label">Key</div>
            <select id="keyOverride">
              <option value="auto" selected>Auto detect</option>
              <option value="C">C</option><option value="C#">C#</option><option value="D">D</option><option value="D#">D#</option>
              <option value="E">E</option><option value="F">F</option><option value="F#">F#</option><option value="G">G</option>
              <option value="G#">G#</option><option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
            </select>
          </div>

          <div class="field sm">
            <div class="label">Mode</div>
            <select id="modeOverride">
              <option value="major" selected>Major</option>
              <option value="minor">Minor</option>
              <option value="dorian">Dorian</option>
              <option value="mixolydian">Mixolydian</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="remixBtn" disabled type="button">Create Remix</button>
          <button class="btn secondary" id="playOrigBtn" disabled type="button">Play Original</button>
          <button class="btn secondary" id="playRemixBtn" disabled type="button">Play Remix</button>
          <button class="btn secondary" id="stopBtn" disabled type="button">Stop</button>
          <button class="btn green" id="downloadBtn" disabled type="button">Download Remix MIDI</button>
          <button class="btn green" id="saveBtn" disabled type="button">Save to Bank</button>
        </div>

        <div id="warn" class="warn"></div>
        <div id="ok" class="ok"></div>

        <div class="label" style="margin-top:12px">Log</div>
        <div id="log" class="log" aria-live="polite"></div>

        <div class="tiny" style="margin-top:10px">
          Shortcuts: <span style="font-family:var(--mono)">Space</span> stop
        </div>
      </section>

      <!-- RIGHT: Stats + Samples -->
      <div style="display:flex; flex-direction:column; gap:16px">
        <section class="card stats">
          <div class="kv"><span class="k">Detected file</span><span class="v" id="statFile">—</span></div>
          <div class="kv"><span class="k">Tempo</span><span class="v" id="statBpm">—</span></div>
          <div class="kv"><span class="k">Key / mode</span><span class="v" id="statKey">—</span></div>
          <div class="kv"><span class="k">Melody track</span><span class="v" id="statTrack">—</span></div>
          <div class="kv"><span class="k">Duration</span><span class="v" id="statDur">—</span></div>

          <div class="divider"></div>
          <div class="tiny">
            If remix harmony sounds off: set the Key manually and try Major/Minor.
          </div>
        </section>

        <section class="card soft">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div>
              <div style="font-weight:950; margin-bottom:4px">Sample MIDIs</div>
              <div class="tiny">Try the tool without uploading anything.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div id="samples" class="list"></div>

          <div class="divider"></div>
          <div class="tiny">
            Tip: load a sample → click <span class="pill">Create Remix</span> → save versions in the bank.
          </div>
        </section>
      </div>
    </div>

    <!-- BANK -->
    <section id="bank" class="card soft" style="margin-top:16px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <div style="font-weight:950; font-size:1.2rem; margin-bottom:4px">Remix Bank</div>
          <div class="tiny">Saved locally on this device (localStorage).</div>
        </div>
        <div class="inline">
          <button class="btn secondary xs" id="bankRefresh" type="button">Refresh</button>
          <button class="btn ghost xs" id="bankClear" type="button">Clear All</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="field">
          <div class="label">Default name when saving</div>
          <input id="bankName" type="text" placeholder="e.g., LoFi v3 — smoother cadence" />
          <div class="tiny" style="margin-top:6px">Leave blank to auto-name.</div>
        </div>
      </div>

      <div class="divider"></div>

      <div id="bankList" class="list"></div>
      <div id="bankEmpty" class="tiny" style="display:none">No saved remixes yet. Make one and click “Save to Bank”.</div>
    </section>
  </div>

  <script>
    // ============================================================
    // IMPORTANT TEMPO FIX (the bug you described):
    // ------------------------------------------------------------
    // The "super fast" playback was caused by us writing MIDI OUT
    // using seconds (time/duration) while also touching tempo in
    // the header in a way that can mismatch how @tonejs/midi
    // converts between seconds <-> ticks.
    //
    // Fix:
    // 1) We STOP calling header.setTempo(...) entirely.
    // 2) We clone the original header (tempo map / PPQ / etc).
    // 3) We write notes using *ticks* (seconds -> ticks using the
    //    output header's mapping). This preserves original tempo
    //    for both the submitted MIDI and the remixed MIDI.
    // ============================================================

    const $ = (id) => document.getElementById(id);
    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

    const PC_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const NOTE_TO_PC = Object.fromEntries(PC_NAMES.map((n,i)=>[n,i]));

    const MODES = {
      major:      [0,2,4,5,7,9,11],
      minor:      [0,2,3,5,7,8,10],
      dorian:     [0,2,3,5,7,9,10],
      mixolydian: [0,2,4,5,7,9,10]
    };

    function midiToNoteName(m){
      const name = PC_NAMES[((m % 12) + 12) % 12];
      const oct = Math.floor(m / 12) - 1;
      return `${name}${oct}`;
    }

    // ---------------------------
    // Better Log
    // ---------------------------
    function logClear(){ $("log").innerHTML = ""; }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function logLine(msg, tag="info"){
      const wrap = $("log");
      const line = document.createElement("div");
      line.className = "line";
      const ts = new Date();
      const time = ts.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
      line.innerHTML =
        `<span class="ts">[${time}]</span> ` +
        `<span class="tag ${tag}">${tag.toUpperCase()}</span>` +
        `<span>${escapeHtml(msg)}</span>`;
      wrap.appendChild(line);
      wrap.scrollTop = wrap.scrollHeight;
    }

    function setWarn(msg){
      const el = $("warn");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = msg;
      logLine(msg, "warn");
    }
    function setOk(msg){
      const el = $("ok");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = msg;
      logLine(msg, "ok");
    }

    function syncStrength(){ $("strengthVal").textContent = Number($("strength").value).toFixed(2); }
    $("strength").addEventListener("input", syncStrength);
    syncStrength();

    // ---------------------------
    // MIDI state
    // ---------------------------
    let midiIn = null;
    let midiOut = null;

    let bpm = 120;
    let keyPc = 0;
    let modeName = "major";
    let beatsPerBar = 4;

    let melodyTrackIndex = -1;
    let melodyNotes = [];

    // stats
    const statFile = $("statFile");
    const statBpm = $("statBpm");
    const statKey = $("statKey");
    const statTrack = $("statTrack");
    const statDur = $("statDur");

    function updateReady(){
      $("remixBtn").disabled = !midiIn;
      $("playOrigBtn").disabled = !midiIn;
      $("playRemixBtn").disabled = !midiOut;
      $("downloadBtn").disabled = !midiOut;
      $("saveBtn").disabled = !midiOut;
    }

    // ---------------------------
    // MIDI analysis helpers
    // ---------------------------
    function getFirstTempo(m){
      try{
        if (m?.header?.tempos?.length){
          const t = m.header.tempos[0];
          if (t && isFinite(t.bpm) && t.bpm > 0) return t.bpm;
        }
      }catch(e){}
      return 120;
    }

    function midiDurationSeconds(m){
      let maxT = 0;
      for (const tr of m.tracks){
        for (const n of (tr.notes || [])){
          maxT = Math.max(maxT, (n.time || 0) + (n.duration || 0));
        }
      }
      return maxT;
    }

    function pickMelodyTrack(m){
      let best = -1, bestScore = -1e9;
      m.tracks.forEach((tr, idx) => {
        const notes = tr.notes || [];
        if (notes.length < 6) return;
        const avg = notes.reduce((a,n)=>a+(n.midi||0),0)/notes.length;
        const dur = notes.reduce((a,n)=>a+(n.duration||0),0) || 0.001;
        const density = notes.length / dur;
        const score = avg - density*25;
        if (score > bestScore){ bestScore = score; best = idx; }
      });
      if (best < 0) best = m.tracks.findIndex(t => (t.notes||[]).length);
      return best;
    }

    // Krumhansl-Schmuckler-ish
    const KS_MAJOR = [6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
    const KS_MINOR = [6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];

    function rotate(arr, k){
      const n = arr.length;
      const out = new Array(n);
      for(let i=0;i<n;i++) out[i] = arr[(i-k+n)%n];
      return out;
    }
    function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s += a[i]*b[i]; return s; }

    function detectKey(notes){
      const hist = new Array(12).fill(0);
      for (const n of notes){
        const pc = ((n.midi||0)%12+12)%12;
        hist[pc] += clamp(n.duration||0.1, 0.01, 10);
      }
      const sum = hist.reduce((a,b)=>a+b,0) || 1;
      const norm = hist.map(x=>x/sum);

      let best = { score:-1e9, pc:0, mode:"major" };
      for (let pc=0; pc<12; pc++){
        const maj = dot(norm, rotate(KS_MAJOR, pc));
        const min = dot(norm, rotate(KS_MINOR, pc));
        if (maj > best.score) best = { score:maj, pc, mode:"major" };
        if (min > best.score) best = { score:min, pc, mode:"minor" };
      }
      return best;
    }

    function scalePcs(tonicPc, mode){
      const deg = MODES[mode] || MODES.major;
      return deg.map(x => (x + tonicPc) % 12);
    }
    function snapToScale(midi, allowedPcs){
      const pc = ((midi%12)+12)%12;
      if (allowedPcs.includes(pc)) return midi;
      for (let s=1; s<=2; s++){
        if (allowedPcs.includes((pc+s)%12)) return midi+s;
        if (allowedPcs.includes((pc-s+12)%12)) return midi-s;
      }
      return midi;
    }

    function overlap(a0,a1,b0,b1){
      const lo = Math.max(a0,b0);
      const hi = Math.min(a1,b1);
      return Math.max(0, hi-lo);
    }

    // ---------------------------
    // TEMPO-SAFE MIDI WRITING HELPERS
    // ---------------------------
    function headerSecondsToTicks(header, sec){
      // robustly convert seconds -> ticks based on tempo map
      if (header && typeof header.secondsToTicks === "function"){
        const t = header.secondsToTicks(sec);
        return Math.max(0, Math.round(t));
      }
      // fallback (should almost never happen)
      const fallbackPpq = header?.ppq || 480;
      const fallbackBpm = bpm || 120;
      const ticks = sec * (fallbackBpm/60) * fallbackPpq;
      return Math.max(0, Math.round(ticks));
    }

    function addNoteBySeconds(track, header, midi, timeSec, durSec, vel){
      const ticks = headerSecondsToTicks(header, Math.max(0, timeSec));
      const endTicks = headerSecondsToTicks(header, Math.max(0, timeSec + Math.max(0.03, durSec)));
      const durationTicks = Math.max(1, endTicks - ticks);

      track.addNote({
        midi: clamp(Math.round(midi), 24, 108),
        ticks,
        durationTicks,
        velocity: clamp(vel ?? 0.85, 0.1, 1.0)
      });
    }

    // ---------------------------
    // Remix generation
    // ---------------------------
    function diatonicTriads(tonicPc, mode){
      const sc = scalePcs(tonicPc, mode);
      const chords = [];
      for (let d=0; d<7; d++){
        chords.push({ degree:d+1, pcs:[sc[d], sc[(d+2)%7], sc[(d+4)%7]], rootPc: sc[d] });
      }
      return chords;
    }

    function fitChordForBar(notes, t0, t1, chords){
      const scores = chords.map(()=>0);
      for (const n of notes){
        const nt0 = n.time||0;
        const nt1 = nt0 + (n.duration||0.1);
        const ov = overlap(t0,t1,nt0,nt1);
        if (ov<=0) continue;
        const pc = ((n.midi||0)%12+12)%12;
        chords.forEach((ch,i)=>{ if (ch.pcs.includes(pc)) scores[i]+=ov; });
      }
      chords.forEach((ch,i)=>{
        if (ch.degree===1) scores[i]*=1.10;
        if (ch.degree===5) scores[i]*=1.06;
      });
      let bestI=0, best=-1e9;
      for (let i=0;i<scores.length;i++){ if (scores[i]>best){ best=scores[i]; bestI=i; } }
      return chords[bestI];
    }

    function improveMelody(notes, tonicPc, mode, strength){
      const allowed = scalePcs(tonicPc, mode);
      const out = notes.map(n => ({...n}));

      for (const n of out){
        n.midi = snapToScale(n.midi, allowed);
      }

      for (let i=1; i<out.length; i++){
        const prev = out[i-1];
        const cur = out[i];
        const leap = cur.midi - prev.midi;
        if (Math.abs(leap) >= 8 && Math.random() < (0.35 + 0.45*strength)){
          let target = prev.midi + clamp(leap, -5, 5);
          target = snapToScale(target, allowed);
          cur.midi = clamp(target, 36, 96);
        }
      }

      if (out.length){
        const last = out[out.length-1];
        const lastPc = ((last.midi%12)+12)%12;
        if (lastPc !== tonicPc){
          const baseOct = Math.floor(last.midi/12);
          let tonicMidi = baseOct*12 + tonicPc;
          if (Math.abs(tonicMidi-last.midi) > 6) tonicMidi += (tonicMidi<last.midi?12:-12);
          last.midi = clamp(tonicMidi, 36, 96);
        }
      }
      return out;
    }

    function chooseVoicing(chordPcs, centerMidi){
      const voiced = chordPcs.map(pc=>{
        let m = centerMidi + ((pc - (centerMidi%12) + 12)%12);
        while (m > centerMidi+6) m -= 12;
        while (m < centerMidi-6) m += 12;
        return m;
      }).sort((a,b)=>a-b);
      return voiced;
    }

    function buildRemix(m){
      const style = $("style").value;
      const strength = clamp(Number($("strength").value), 0, 1);

      beatsPerBar = 4;

      // we keep the ORIGINAL tempo (from the file) for analysis
      // and we preserve the ORIGINAL header tempo map in the output.
      bpm = getFirstTempo(m);
      const beatSec = 60/Math.max(1,bpm);
      const barSec = beatsPerBar*beatSec;

      const det = detectKey(melodyNotes);
      const keyOverride = $("keyOverride").value;
      modeName = $("modeOverride").value;
      keyPc = (keyOverride==="auto") ? det.pc : NOTE_TO_PC[keyOverride];

      const durSec = midiDurationSeconds(m);
      const bars = Math.max(1, Math.ceil(durSec / barSec));

      const chords = diatonicTriads(keyPc, modeName);
      const chordPlan = [];
      for (let b=0; b<bars; b++){
        const t0=b*barSec, t1=(b+1)*barSec;
        chordPlan.push({ t0,t1, chord: fitChordForBar(melodyNotes,t0,t1,chords) });
      }
      const tonic = chords.find(c=>c.degree===1) || chords[0];
      chordPlan[0].chord = tonic;
      chordPlan[chordPlan.length-1].chord = tonic;

      const out = new Midi();

      // Clone the original header (tempo map / ppq / etc).
      // DO NOT call setTempo here.
      try{ out.header.fromJSON(m.header.toJSON()); }catch(e){}

      // Melody track (tempo-safe: write using ticks via header mapping)
      const melT = out.addTrack(); melT.name = "Melody";
      const mel = improveMelody(
        melodyNotes.map(n=>({ midi:n.midi, time:n.time, duration:n.duration, velocity:n.velocity ?? 0.85 })),
        keyPc, modeName, strength
      );
      for (const n of mel){
        addNoteBySeconds(melT, out.header,
          n.midi,
          Math.max(0, n.time),
          Math.max(0.03, n.duration ?? 0.12),
          clamp(n.velocity ?? 0.85, 0.1, 1.0)
        );
      }

      // Chords track
      const chT = out.addTrack(); chT.name = "Chords";
      for (const slot of chordPlan){
        const center = (style==="baroque") ? 58 : 60;
        const voiced = chooseVoicing(slot.chord.pcs, center);

        if (style==="edm"){
          const stabDur = 0.45*beatSec;
          const times = [slot.t0, slot.t0 + 2*beatSec];
          for (const tt of times){
            for (const m0 of voiced){
              addNoteBySeconds(chT, out.header, m0, tt, stabDur, 0.55 + 0.15*strength);
            }
          }
        } else if (style==="baroque"){
          const step = 0.5*beatSec;
          let t = slot.t0;
          let i = 0;
          while (t < slot.t1 - 0.02){
            const m0 = voiced[i % voiced.length];
            addNoteBySeconds(chT, out.header, m0, t, step*0.92, 0.35 + 0.18*strength);
            t += step; i++;
          }
        } else {
          const dur = (slot.t1-slot.t0) * 0.98;
          for (const m0 of voiced){
            addNoteBySeconds(chT, out.header, m0, slot.t0, dur, 0.34 + 0.16*strength);
          }
        }
      }

      // Bass track
      const baT = out.addTrack(); baT.name = "Bass";
      for (let i=0;i<chordPlan.length;i++){
        const slot = chordPlan[i];
        const rootPc = slot.chord.rootPc;
        let rootMidi = 36 + ((rootPc - (36%12) + 12)%12);
        while (rootMidi > 48) rootMidi -= 12;
        rootMidi = clamp(rootMidi, 28, 55);

        if (style==="edm"){
          const step = 0.5*beatSec;
          let t=slot.t0;
          while (t < slot.t1 - 0.02){
            addNoteBySeconds(baT, out.header, rootMidi, t, step*0.92, 0.68 + 0.20*strength);
            t += step;
          }
        } else {
          const half = 2*beatSec;
          addNoteBySeconds(baT, out.header, rootMidi, slot.t0, half*0.98, 0.55 + 0.14*strength);
          if (strength > 0.25){
            const fifthPc = (rootPc + 7) % 12;
            let fifthMidi = 36 + ((fifthPc - (36%12) + 12)%12);
            while (fifthMidi > 55) fifthMidi -= 12;
            fifthMidi = clamp(fifthMidi, 28, 60);
            addNoteBySeconds(baT, out.header, fifthMidi, slot.t0 + half, half*0.85, 0.50 + 0.10*strength);
          }
        }
      }

      return { out, info: { bpm, key:`${PC_NAMES[keyPc]} ${modeName}`, bars, style, durSec } };
    }

    // ---------------------------
    // Tone.js playback (robust stop)
    // ---------------------------
    let audioReady = false;
    let lead, pad, bassSynth;
    let reverb, limiter, masterGain;
    let part = null;

    async function ensureAudio(){
      if (Tone.context.state !== "running") await Tone.start();
      if (audioReady) return;

      masterGain = new Tone.Gain(0.95).toDestination();
      limiter = new Tone.Limiter(-1).connect(masterGain);
      reverb = new Tone.Reverb({ decay: 2.4, wet: 0.14 }).connect(limiter);

      lead = new Tone.PolySynth(Tone.Synth, {
        volume: -12,
        options: { oscillator:{type:"triangle"}, envelope:{attack:0.01, decay:0.08, sustain:0.20, release:0.6} }
      }).connect(reverb);

      pad = new Tone.PolySynth(Tone.Synth, {
        volume: -16,
        options: { oscillator:{type:"sawtooth"}, envelope:{attack:0.08, decay:0.2, sustain:0.6, release:1.1} }
      }).connect(reverb);

      bassSynth = new Tone.MonoSynth({
        volume: -10,
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.10, sustain: 0.6, release: 0.12 }
      }).connect(limiter);

      audioReady = true;
    }

    function stopAllSound(tag="stop"){
      try{ if (part){ part.stop(); part.dispose(); part = null; } }catch(e){}
      try{
        Tone.Transport.stop();
        Tone.Transport.cancel(0);
        Tone.Transport.position = 0;
      }catch(e){}
      try{ lead?.releaseAll?.(); }catch(e){}
      try{ pad?.releaseAll?.(); }catch(e){}
      try{ bassSynth?.triggerRelease?.(); }catch(e){}

      $("stopBtn").disabled = true;
      logLine("Stopped playback.", tag);
    }

    function flatten(m){
      const all = [];
      for (const tr of m.tracks){
        const name = (tr.name||"").toLowerCase();
        for (const n of (tr.notes||[])){
          all.push({
            midi: n.midi,
            time: n.time ?? 0,
            duration: n.duration ?? 0.1,
            velocity: n.velocity ?? 0.8,
            track: name
          });
        }
      }
      all.sort((a,b)=>a.time-b.time);
      return all;
    }

    function synthForTrack(name){
      if (name.includes("bass")) return "bass";
      if (name.includes("chord") || name.includes("pad")) return "pad";
      return "lead";
    }

    function playMidi(m){
      stopAllSound("stop");
      const notes = flatten(m);
      if (!notes.length) return;

      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      Tone.Transport.position = 0;

      const events = notes.map(n => ({
        time: Math.max(0, n.time), // seconds
        midi: clamp(Math.round(n.midi), 24, 108),
        dur: Math.max(0.03, n.duration),
        vel: clamp(n.velocity ?? 0.8, 0.1, 1.0),
        synth: synthForTrack(n.track)
      }));

      part = new Tone.Part((time, v) => {
        const nn = midiToNoteName(v.midi);
        if (v.synth === "bass"){
          bassSynth.triggerAttackRelease(nn, v.dur, time, v.vel);
        } else if (v.synth === "pad"){
          pad.triggerAttackRelease(nn, v.dur, time, v.vel);
        } else {
          lead.triggerAttackRelease(nn, v.dur, time, v.vel);
        }
      }, events);

      part.start(0);
      Tone.Transport.start("+0.02");
      $("stopBtn").disabled = false;
    }

    // ---------------------------
    // Load MIDI
    // ---------------------------
    function setStats({fileName, bpm, key, trackName, trackIndex, durSec}){
      statFile.textContent = fileName || "—";
      statBpm.textContent = bpm ? `${Math.round(bpm)} BPM` : "—";
      statKey.textContent = key || "—";
      statTrack.textContent = (trackIndex != null && trackIndex >= 0)
        ? `#${trackIndex+1} (${trackName || "unnamed"})`
        : "—";
      statDur.textContent = (durSec != null) ? `${durSec.toFixed(2)}s` : "—";
    }

    function parseMidiArrayBuffer(buf, fileName){
      setWarn(null); setOk(null);
      midiOut = null;

      midiIn = new Midi(buf);
      bpm = getFirstTempo(midiIn);

      melodyTrackIndex = pickMelodyTrack(midiIn);
      const tr = midiIn.tracks[melodyTrackIndex];
      melodyNotes = (tr?.notes || []).map(n => ({
        midi: n.midi, time: n.time ?? 0, duration: n.duration ?? 0.1, velocity: n.velocity ?? 0.85
      }));

      const dur = midiDurationSeconds(midiIn);
      const det = detectKey(melodyNotes);

      logLine(`Loaded: ${fileName || "MIDI"}`, "info");
      logLine(`Tempo: ~${Math.round(bpm)} BPM`, "info");
      logLine(`Melody track: #${melodyTrackIndex+1} (${tr?.name || "unnamed"})`, "info");
      logLine(`Key guess: ${PC_NAMES[det.pc]} (${det.mode} leaning)`, "info");
      logLine(`Next: Click “Create Remix”.`, "info");

      setStats({
        fileName: fileName || "MIDI",
        bpm,
        key: `${PC_NAMES[det.pc]} (guess)`,
        trackName: tr?.name,
        trackIndex: melodyTrackIndex,
        durSec: dur
      });

      updateReady();
    }

    $("midiFile").addEventListener("change", async () => {
      const f = $("midiFile").files?.[0];
      if(!f){ midiIn=null; midiOut=null; updateReady(); return; }
      try{
        const buf = await f.arrayBuffer();
        logClear();
        parseMidiArrayBuffer(buf, f.name);
      }catch(e){
        console.error(e);
        setWarn("Failed to parse MIDI. Try a different .mid file.");
        midiIn=null; midiOut=null;
        updateReady();
      }
    });

    // ---------------------------
    // Samples (no-upload)
    // ---------------------------
    function addNoteSecondsSafe(track, header, midi, time, dur, vel=0.85){
      addNoteBySeconds(track, header, midi, time, dur, vel);
    }

    function makeSampleMidi(sampleId){
      const cfg = {
        popC:   { title:"Pop-ish Melody (C major)", key:"C major", tempo:110, seq:[60,64,67,69,67,64,62,60] },
        minorA: { title:"Minor Hook (A minor)", key:"A minor", tempo:95,  seq:[69,72,76,79,76,74,72,69] },
        riffD:  { title:"Riff + Rests (D mixolydian-ish)", key:"D mixolydian", tempo:120, seq:[62,64,66,69,67,66,64,62] }
      }[sampleId];

      const m = new Midi();
      // For samples, set a single tempo *safely* by writing header JSON:
      // @tonejs/midi supports header.tempos; simplest: add tempo event via header.setTempo if available,
      // but since tempo-setting semantics can vary, we instead:
      // - leave default, and encode times in ticks using our conversion fallback with known bpm.
      // We'll still store cfg.tempo separately for display/analysis.
      const t = m.addTrack(); t.name = cfg.title;

      const beat = 60 / cfg.tempo;
      const bar = 4 * beat;
      const bars = 8;

      // Use the sample's bpm for fallback conversion (since header tempo might be default)
      const prevBpm = bpm;
      bpm = cfg.tempo;

      for (let b=0; b<bars; b++){
        const t0 = b * bar;
        for (let i=0; i<8; i++){
          const n = cfg.seq[i % cfg.seq.length];
          const time = t0 + i*(0.5*beat);
          const dur = 0.45*beat;
          const vel = 0.78 + 0.10*Math.sin((b+i)*0.7);

          if (sampleId==="riffD" && (i===2 || i===6) && (b%2===1)) continue;
          addNoteSecondsSafe(t, m.header, n, time, dur, vel);
        }
      }

      bpm = prevBpm;
      return { midi: m, title: cfg.title, tempo: cfg.tempo, keyText: cfg.key };
    }

    const SAMPLE_DEFS = [
      { id:"popC"   },
      { id:"minorA" },
      { id:"riffD"  }
    ];

    function renderSamples(){
      const wrap = $("samples");
      wrap.innerHTML = "";
      for (const s of SAMPLE_DEFS){
        const sample = makeSampleMidi(s.id);

        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div class="meta">
            <div class="title">${escapeHtml(sample.title)}</div>
            <div class="sub">${escapeHtml(sample.keyText)} • ${sample.tempo} bpm • 8 bars</div>
          </div>
          <div class="actions">
            <button class="btn xs" data-act="load">Load</button>
            <button class="btn secondary xs" data-act="play">Play</button>
          </div>
        `;

        row.querySelector('[data-act="load"]').addEventListener("click", () => {
          try{
            stopAllSound("stop");
            logClear();
            const bytes = sample.midi.toArray();
            parseMidiArrayBuffer(new Uint8Array(bytes).buffer, `Sample: ${sample.title}`);
            setOk("Sample loaded. Create a remix when ready.");
          }catch(e){
            console.error(e);
            setWarn("Failed to load sample (unexpected).");
          }
        });

        row.querySelector('[data-act="play"]').addEventListener("click", async () => {
          try{
            stopAllSound("stop");
            await ensureAudio();
            playMidi(sample.midi);
            logLine(`Playing sample: ${sample.title}`, "play");
          }catch(e){
            console.error(e);
            setWarn("Audio failed to start. Click play again.");
          }
        });

        wrap.appendChild(row);
      }
    }

    // ---------------------------
    // Download helper
    // ---------------------------
    function downloadMidiBytes(bytes, filename){
      const blob = new Blob([bytes], { type: "audio/midi" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ---------------------------
    // Buttons
    // ---------------------------
    $("remixBtn").addEventListener("click", () => {
      setWarn(null); setOk(null);
      if (!midiIn) return;

      stopAllSound("stop");
      logLine("Creating remix…", "info");

      try{
        const { out, info } = buildRemix(midiIn);
        midiOut = out;

        logLine(`Style: ${info.style}`, "info");
        logLine(`Key/Mode: ${info.key}`, "info");
        logLine(`Bars: ${info.bars}`, "info");
        logLine("Done. Play, download, or save to bank.", "ok");

        statBpm.textContent = `${Math.round(info.bpm)} BPM`;
        statKey.textContent = info.key;

        updateReady();
        setOk("Remix created.");
      }catch(e){
        console.error(e);
        setWarn(e?.message || "Remix failed. Check console.");
        midiOut = null;
        updateReady();
      }
    });

    $("playOrigBtn").addEventListener("click", async () => {
      if (!midiIn) return;
      setWarn(null);
      try{
        await ensureAudio();
        playMidi(midiIn);
        logLine("Playing original.", "play");
      }catch(e){
        console.error(e);
        setWarn("Audio failed to start. Click play again.");
      }
    });

    $("playRemixBtn").addEventListener("click", async () => {
      if (!midiOut) return;
      setWarn(null);
      try{
        await ensureAudio();
        playMidi(midiOut);
        logLine("Playing remix.", "play");
      }catch(e){
        console.error(e);
        setWarn("Audio failed to start. Click play again.");
      }
    });

    $("stopBtn").addEventListener("click", () => stopAllSound("stop"));

    $("downloadBtn").addEventListener("click", () => {
      if (!midiOut) return;
      try{
        const bytes = midiOut.toArray();
        downloadMidiBytes(bytes, "remix_assistant_output.mid");
        setOk("Downloaded remix MIDI.");
      }catch(e){
        console.error(e);
        setWarn("Download failed. Try remixing again.");
      }
    });

    // keyboard: SPACE stop
    window.addEventListener("keydown", (e) => {
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea" || tag === "select") return;
      if (e.code === "Space"){ e.preventDefault(); stopAllSound("stop"); }
    });

    // ---------------------------
    // Bank (save/play/stop/download/rename)
    // ---------------------------
    const BANK_KEY = "liam_remix_bank_v2";
    let bankNowPlayingId = null;

    function loadBank(){
      try{
        const raw = localStorage.getItem(BANK_KEY);
        const arr = JSON.parse(raw || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function saveBank(arr){ localStorage.setItem(BANK_KEY, JSON.stringify(arr)); }

    function fmtWhen(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return iso; }
    }

    function bytesToBase64(u8){
      let binary = "";
      const chunk = 0x8000;
      for (let i=0; i<u8.length; i+=chunk){
        binary += String.fromCharCode.apply(null, u8.subarray(i, i+chunk));
      }
      return btoa(binary);
    }
    function base64ToBytes(b64){
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return u8;
    }

    function currentMeta(){
      return {
        style: $("style").value,
        strength: Number($("strength").value),
        keyOverride: $("keyOverride").value,
        mode: $("modeOverride").value
      };
    }

    function renderBank(){
      const list = loadBank().sort((a,b)=> (b.ts||"").localeCompare(a.ts||""));
      const wrap = $("bankList");
      const empty = $("bankEmpty");

      wrap.innerHTML = "";

      if (!list.length){
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      for (const item of list){
        const row = document.createElement("div");
        row.className = "item";

        const meta = document.createElement("div");
        meta.className = "meta";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = item.title || "Untitled Remix";

        const sub = document.createElement("div");
        sub.className = "sub";
        const bpmTxt = item.info?.bpm ? `${Math.round(item.info.bpm)} bpm` : "— bpm";
        const keyTxt = item.info?.key || "—";
        const styleTxt = item.info?.style || "—";
        const whenTxt = item.ts ? fmtWhen(item.ts) : "";
        sub.textContent = `${keyTxt} • ${bpmTxt} • ${styleTxt}${whenTxt ? " • " + whenTxt : ""}`;

        meta.appendChild(title);
        meta.appendChild(sub);

        const actions = document.createElement("div");
        actions.className = "actions";

        const playBtn = document.createElement("button");
        playBtn.className = "btn secondary xs";
        playBtn.textContent = "Play";

        const stopBtn = document.createElement("button");
        stopBtn.className = "btn secondary xs";
        stopBtn.textContent = "Stop";

        const dlBtn = document.createElement("button");
        dlBtn.className = "btn green xs";
        dlBtn.textContent = "Download MIDI";

        const renameBtn = document.createElement("button");
        renameBtn.className = "btn xs";
        renameBtn.textContent = "Rename";

        const delBtn = document.createElement("button");
        delBtn.className = "btn ghost xs";
        delBtn.textContent = "Delete";

        playBtn.addEventListener("click", async () => {
          try{
            setWarn(null);
            await ensureAudio();
            const bytes = base64ToBytes(item.midiB64);
            const m = new Midi(bytes);
            playMidi(m);
            bankNowPlayingId = item.id;
            logLine(`Playing bank item: ${item.title || "Untitled"}`, "play");
          }catch(e){
            console.error(e);
            setWarn("Could not play saved remix. Try refreshing or re-saving.");
          }
        });

        stopBtn.addEventListener("click", () => {
          stopAllSound("stop");
          bankNowPlayingId = null;
        });

        dlBtn.addEventListener("click", () => {
          try{
            const bytes = base64ToBytes(item.midiB64);
            const safe = (item.title || "remix").replace(/[^\w\- ]+/g,"").trim().slice(0,60) || "remix";
            downloadMidiBytes(bytes, `${safe}.mid`);
            setOk("Downloaded bank MIDI.");
          }catch(e){
            console.error(e);
            setWarn("Download failed for this bank item.");
          }
        });

        renameBtn.addEventListener("click", () => {
          const newTitle = prompt("Rename this remix:", item.title || "Untitled Remix");
          if (newTitle == null) return;
          const t = newTitle.trim();
          if (!t){
            setWarn("Rename cancelled (title was empty).");
            return;
          }
          const arr = loadBank();
          const idx = arr.findIndex(x => x.id === item.id);
          if (idx >= 0){
            arr[idx].title = t;
            saveBank(arr);
            renderBank();
            setOk("Renamed bank item.");
          }
        });

        delBtn.addEventListener("click", () => {
          const ok = confirm(`Delete "${item.title || "Untitled Remix"}"?`);
          if (!ok) return;
          const arr = loadBank().filter(x => x.id !== item.id);
          saveBank(arr);
          if (bankNowPlayingId === item.id) bankNowPlayingId = null;
          renderBank();
          setOk("Deleted bank item.");
        });

        actions.appendChild(playBtn);
        actions.appendChild(stopBtn);
        actions.appendChild(dlBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(delBtn);

        row.appendChild(meta);
        row.appendChild(actions);
        wrap.appendChild(row);
      }
    }

    $("saveBtn").addEventListener("click", () => {
      if (!midiOut) return;
      try{
        const bytes = midiOut.toArray();
        const b64 = bytesToBase64(bytes);

        const info = {
          bpm,
          key: statKey.textContent === "—" ? "" : statKey.textContent,
          style: $("style").value,
          strength: Number($("strength").value)
        };

        const titleRaw = ($("bankName").value || "").trim();
        const title = titleRaw || `Remix • ${info.style.toUpperCase()} • ${Math.round(info.bpm)}bpm`;

        const item = {
          id: `bank_${Date.now().toString(16)}_${Math.random().toString(16).slice(2,8)}`,
          ts: new Date().toISOString(),
          title,
          info,
          condition: currentMeta(),
          midiB64: b64
        };

        const arr = loadBank();
        arr.push(item);
        saveBank(arr);

        $("bankName").value = "";
        renderBank();
        setOk("Saved remix to bank.");
      }catch(e){
        console.error(e);
        setWarn("Failed to save to bank (unexpected).");
      }
    });

    $("bankRefresh").addEventListener("click", () => renderBank());
    $("bankClear").addEventListener("click", () => {
      const ok = confirm("Clear the entire bank? This cannot be undone.");
      if (!ok) return;
      localStorage.removeItem(BANK_KEY);
      bankNowPlayingId = null;
      renderBank();
      setOk("Cleared entire bank.");
    });

    // ---------------------------
    // Init
    // ---------------------------
    logLine("Ready. Load a sample or upload a MIDI.", "info");
    renderSamples();
    renderBank();
    updateReady();
  </script>
</body>
</html>





